---
/**
 * Teleport - Vim-style keyboard navigation for Astro sites.
 *
 * Provides j/k navigation in sidebar, Ctrl+d/u for content scroll,
 * h/l for prev/next page, and t for fuzzy finder.
 */
interface Props {
  /** CSS selector for navigable items (default: '.nav-item') */
  itemSelector?: string;
  /** CSS selector for content container (default: 'main') */
  contentSelector?: string;
  /** CSS selector for sidebar container (default: '.sidebar') */
  sidebarSelector?: string;
  /** Class to add to highlighted item (default: 'teleport-highlight') */
  highlightClass?: string;
  /** Enable fuzzy finder (emits teleport:open-finder event) */
  enableFinder?: boolean;
}

const {
  itemSelector = '.nav-item',
  contentSelector = 'main',
  sidebarSelector = '.sidebar',
  highlightClass = 'teleport-highlight',
  enableFinder = false,
} = Astro.props;
---

<teleport-config
  data-item-selector={itemSelector}
  data-content-selector={contentSelector}
  data-sidebar-selector={sidebarSelector}
  data-highlight-class={highlightClass}
  data-enable-finder={enableFinder.toString()}
  style="display: none;"
></teleport-config>

<style is:global>
  .teleport-highlight {
    outline: 2px solid var(--color-accent, #3b82f6);
    outline-offset: -2px;
    background-color: var(--color-accent-dim, rgba(59, 130, 246, 0.1));
  }
</style>

<script>
  import { initTeleport, type Teleport } from './src/index.js';

  function setupTeleport(): Teleport | null {
    const configEl = document.querySelector('teleport-config');
    if (!configEl) return null;

    const itemSelector = configEl.getAttribute('data-item-selector') || '.nav-item';
    const contentSelector = configEl.getAttribute('data-content-selector') || 'main';
    const sidebarSelector = configEl.getAttribute('data-sidebar-selector') || '.sidebar';
    const highlightClass = configEl.getAttribute('data-highlight-class') || 'teleport-highlight';
    const enableFinder = configEl.getAttribute('data-enable-finder') === 'true';

    return initTeleport({
      itemSelector,
      contentContainer: contentSelector,
      sidebarContainer: sidebarSelector,
      highlightClass,
      onOpenFinder: enableFinder
        ? () => document.dispatchEvent(new CustomEvent('teleport:open-finder'))
        : undefined,
    });
  }

  // Run on initial load
  let teleport = setupTeleport();

  // Re-run after Astro page transitions
  document.addEventListener('astro:after-swap', () => {
    teleport?.destroy();
    teleport = setupTeleport();
  });
</script>
